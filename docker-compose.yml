services:
  airflow-init:
    image: apache/airflow:2.9.2
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      # CRITICAL: Airflow metadata database connection points to RDS
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: "postgresql+psycopg2://${PG_USER}:${PG_PASSWORD}@${PG_HOST}:${PG_PORT}/${PG_DB}"
      # CRITICAL: Add this to install dependencies during the build/startup process
      _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS}
    volumes:
      - ./dags:/opt/airflow/dags
      - ./:/opt/project
      - airflow_home:/opt/airflow
    entrypoint: /bin/bash
    command:
      - -lc
      - |
        set -e
        # Initialize Airflow metadata on your RDS instance
        airflow db init
        airflow users create \
          --username admin --password admin \
          --firstname A --lastname I --role Admin --email admin@example.com

  airflow-scheduler:
    image: apache/airflow:2.9.2
    depends_on:
      - airflow-init
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      # Airflow metadata connection
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: "postgresql+psycopg2://${PG_USER}:${PG_PASSWORD}@${PG_HOST}:${PG_PORT}/${PG_DB}"
      # Connection used by your DAG code (weather_etl.py)
      AIRFLOW_CONN_WEATHER_DB: "postgresql+psycopg2://${PG_USER}:${PG_PASSWORD}@${PG_HOST}:${PG_PORT}/${PG_DB}"
      # CRITICAL: Add this to install dependencies
      _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS}
    volumes:
      - ./dags:/opt/airflow/dags
      - ./:/opt/project
      - airflow_home:/opt/airflow
    command: scheduler

  airflow-webserver:
    image: apache/airflow:2.9.2
    depends_on:
      - airflow-scheduler
    ports:
      - "8080:8080"
    environment:
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      # Airflow metadata connection
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: "postgresql+psycopg2://${PG_USER}:${PG_PASSWORD}@${PG_HOST}:${PG_PORT}/${PG_DB}"
      # Connection used by your DAG code (weather_etl.py)
      AIRFLOW_CONN_WEATHER_DB: "postgresql+psycopg2://${PG_USER}:${PG_PASSWORD}@${PG_HOST}:${PG_PORT}/${PG_DB}"
      AIRFLOW__WEBSERVER__WEB_SERVER_HOST: "0.0.0.0"
      # CRITICAL: Add this to install dependencies
      _PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS}
    volumes:
      - ./dags:/opt/airflow/dags
      - ./:/opt/project
      - airflow_home:/opt/airflow
    command: webserver

volumes:
  airflow_home: